oats-schema-version: 2
include:
  - ./oats-template.yml
input:
  - path: /api/Aws/ListBuckets
  - path: /api/HttpClient/Get
  - path: /api/HttpClient/GetError
  - path: /api/MsSql/ServerInfo
  - path: /api/MsSql/Tables
  - path: /api/Redis/LeftPush
  - path: /api/todo/items
expected:
  logs:
    - logql: '{ service_name="aspnetcore" } |~ `Application started.`'
      regexp: 'Application started'
  metrics:
    - promql: db_client_operation_duration_seconds_count{}
      value: '>= 0'
    - promql: http_client_request_duration_seconds_count{}
      value: '>= 1'
    - promql: http_client_request_duration_seconds_count{http_request_method="GET", http_response_status_code="200"}
      value: '>= 1'
    - promql: http_server_request_duration_seconds_count{}
      value: '>= 1'
  traces:
    - traceql: '{ resource.process.pid > 0 }'
      equals: 'GET'
    - traceql: '{ span.http.route =~ "api/HttpClient/Get" }'
      equals: 'GET api/HttpClient/Get'
      attributes:
        http.request.method: GET
    - traceql: '{ span.http.route =~ "api/HttpClient/Get" }'
      equals: 'GET api/HttpClient/Get'
      attributes:
        service.name: aspnetcore
        service.version: 1.0.0.0
        telemetry.distro.name: grafana-opentelemetry-dotnet
        deployment.environment: production
        process.runtime.name: .NET
        telemetry.sdk.name: opentelemetry
        telemetry.sdk.language: dotnet
      attribute-regexp:
        host.name: .+
        process.runtime.description: .NET.+
        process.runtime.version: .+
        telemetry.distro.version: .+
        telemetry.sdk.version: .+
    - traceql: '{ span.http.route =~ "api/HttpClient/GetError" }'
      equals: 'GET api/HttpClient/GetError'
      attributes:
        http.request.method: GET
    - traceql: '{ span.http.route =~ "api/HttpClient/GetError" }'
      equals: 'GET'
      attributes:
        error.type: '500'
        http.request.method: GET
        http.response.status_code: 500
    - traceql: '{ span.http.route =~ "api/MsSql/ServerInfo" }'
      equals: 'EXECUTE sp_server_info'
      attributes:
        db.system.name: microsoft.sql_server
        db.namespace: master
        db.operation.name: EXECUTE
        db.stored_procedure.name: sp_server_info
        db.query.summary: EXECUTE sp_server_info
        server.address: mssql
        otel.library.name: OpenTelemetry.Instrumentation.SqlClient
    - traceql: '{ span.http.route =~ "api/MsSql/Tables" }'
      equals: 'SELECT INFORMATION_SCHEMA.TABLES'
      attributes:
        db.system.name: microsoft.sql_server
        db.namespace: master
        db.query.text: SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES
        db.query.summary: SELECT INFORMATION_SCHEMA.TABLES
        server.address: mssql
        otel.library.name: OpenTelemetry.Instrumentation.SqlClient
    - traceql: '{ span.http.route =~ "api/Redis/LeftPush" }'
      equals: 'LPUSH'
      attributes:
        db.statement: LPUSH
        db.system: redis
        db.redis.database_index: '0'
        server.address: redis
    - traceql: '{ span.http.route =~ "/api/todo/items/" }'
      equals: 'main'
      attributes:
        db.system: sqlite
        db.name: main
        peer.service: /app/App_Data/TodoApp.db
        otel.library.name: OpenTelemetry.Instrumentation.EntityFrameworkCore
    - traceql: '{ span.http.route =~ "api/Aws/ListBuckets" }'
      equals: 'S3.ListBuckets'
      attributes:
        otel.library.name: AWSSDK.S3
        rpc.method: ListBuckets
        rpc.service: S3
        rpc.system: aws-api
      attribute-regexp:
        aws.request_id: .+
